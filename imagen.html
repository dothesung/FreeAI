<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Tạo Ảnh AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4F46E5;
            --primary-light: #6366F1;
            --primary-dark: #4338CA;
            --secondary-color: #8B5CF6;
            --light-bg: #F8FAFC;
            --border-color: #E2E8F0;
            --text-color: #1E293B;
            --text-light: #64748B;
            --success-color: #10B981;
            --error-color: #EF4444;
            --border-radius: 10px;
            --box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04), 0 0 1px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --gradient-primary: linear-gradient(135deg, #4F46E5, #7C3AED);
            --card-bg: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.5;
            padding: 1.5rem;
            background-image: radial-gradient(circle at 80% 10%, rgba(124, 58, 237, 0.03) 0%, transparent 600px), radial-gradient(circle at 20% 90%, rgba(79, 70, 229, 0.03) 0%, transparent 600px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            padding: 1rem 0 2rem;
            text-align: center;
            position: relative;
        }

        h1.main-header {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5em;
            text-align: center;
            color: transparent;
            background: linear-gradient(45deg, #00f3ff 30%, #a855f7 70%);
            -webkit-background-clip: text;
            background-clip: text;
            text-shadow: 0 0 15px rgba(0, 243, 255, 0.4);
        }

        p.description {
            font-size: 1.1rem;
            color: var(--text-light);
            max-width: 700px;
            margin: 1rem auto 0;
            line-height: 1.6;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            align-items: flex-start;
        }
        
        .full-width-section {
            grid-column: 1 / -1;
            margin-top: 1.5rem;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }
        .card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
        }
        .section-title i {
            margin-right: 0.75rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            color: var(--text-light);
            font-weight: 500;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background-color: #fff;
            transition: var(--transition);
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .select-wrapper {
            position: relative;
        }
        .select-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            pointer-events: none;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 0.85rem 1.5rem;
            cursor: pointer;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: 0 2px 6px rgba(79, 70, 229, 0.3);
        }
        .btn i {
            margin-right: 0.5rem;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.4);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 6px rgba(79, 70, 229, 0.3);
        }
        .btn-secondary {
            background: var(--card-bg);
            color: var(--primary-color);
            border: 1px solid var(--border-color);
            box-shadow: none;
        }
        .btn-secondary:hover {
            background: #f0f4f7;
            color: var(--primary-dark);
            border-color: var(--primary-light);
            box-shadow: none;
            transform: translateY(-1px);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
            margin: 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .image-grid-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .image-grid-item {
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }
        .image-grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .image-grid-item.error-item {
            background-color: #fee2e2;
            color: #b91c1c;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            text-align: center;
            font-size: 0.9rem;
            word-break: break-all;
        }
        .error-message-box {
             background-color: #fee2e2;
             color: #991b1b;
             border: 1px solid #fecaca;
             padding: 1rem;
             border-radius: var(--border-radius);
             margin-top: 1rem;
             text-align: center;
        }
        
        .placeholder-text {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-light);
        }
        .placeholder-text i {
            font-size: 3rem;
            opacity: 0.5;
            margin-bottom: 1rem;
            display: block;
        }
        
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .history-item {
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }
        .history-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .history-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }
        .empty-history {
            grid-column: 1 / -1;
            text-align: center;
            padding: 2rem 0;
            color: var(--text-light);
        }

        @media (max-width: 900px) {
            .content { grid-template-columns: 1fr; }
        }
        @media (max-width: 600px) {
            body { padding: 1rem; }
            .form-row, .button-group { grid-template-columns: 1fr; }
            h1.main-header { font-size: 2rem; }
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="main-header">Trình Tạo Ảnh AI</h1>
            <p class="description">Hệ thống tạo hình ảnh nâng cao dựa trên AI, biến ý tưởng của bạn thành tác phẩm nghệ thuật.</p>
        </header>

        <div class="content">
            <!-- Cột cài đặt -->
            <section id="settings-section">
                 <form id="generation-form" class="card">
                    <h2 class="section-title"><i class="fas fa-magic-wand-sparkles"></i> Bảng điều khiển</h2>

                    <div class="form-group">
                        <label for="prompt">Câu lệnh (Prompt)</label>
                        <textarea id="prompt" name="prompt" rows="4" placeholder="Ví dụ: một con rồng hùng vĩ bay trên những ngọn núi tuyết..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="model">Model</label>
                            <div class="select-wrapper">
                                <select id="model" name="model">
                                    <option value="img4">img4 (Chất lượng cao)</option>
                                    <option value="img3">img3</option>
                                    <option value="uncen">uncen (Không kiểm duyệt)</option>
                                </select>
                                <i class="fas fa-chevron-down select-icon"></i>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="aspect_ratio">Tỷ lệ khung hình</label>
                             <div class="select-wrapper">
                                <select id="aspect_ratio" name="aspect_ratio">
                                    <option value="IMAGE_ASPECT_RATIO_LANDSCAPE">Ngang (16:9)</option>
                                    <option value="IMAGE_ASPECT_RATIO_SQUARE">Vuông (1:1)</option>
                                    <option value="IMAGE_ASPECT_RATIO_PORTRAIT">Dọc (9:16)</option>
                                </select>
                                <i class="fas fa-chevron-down select-icon"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="num_images">Số lượng ảnh</label>
                            <input type="number" id="num_images" name="num_images" value="1" min="1" max="4">
                        </div>
                        <div class="form-group">
                            <label for="seed">Seed (Tùy chọn)</label>
                            <input type="number" id="seed" name="seed" placeholder="Để trống để tạo ngẫu nhiên">
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" id="generate-btn" class="btn">
                            <i class="fas fa-palette"></i>
                            Tạo ảnh ngay
                        </button>
                        <button type="button" id="clear-btn" class="btn btn-secondary">
                             <i class="fas fa-eraser"></i> Xóa
                        </button>
                    </div>
                </form>
            </section>

            <!-- Cột kết quả -->
            <section id="result-area" class="result-area">
                <div class="card">
                    <h2 class="section-title"><i class="fas fa-images"></i> Kết quả</h2>
                    <div id="status-container">
                        <div id="placeholder-text" class="placeholder-text">
                           <i class="fas fa-image"></i>
                           <span>Kết quả tạo ảnh sẽ xuất hiện ở đây</span>
                        </div>
                    </div>
                    <div id="image-display-area" class="image-grid-display">
                        <!-- Các ảnh sẽ được thêm vào đây bằng JS -->
                    </div>
                </div>
            </section>
            
            <section class="full-width-section">
                <div class="card">
                    <div class="section-title" style="justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; display: flex; align-items: center;"><i class="fas fa-history"></i>Lịch sử tạo ảnh</h2>
                        <button id="clear-history-btn" class="btn btn-secondary" style="width: auto; height: auto; padding: 0.5rem 1rem;">
                            <i class="fas fa-trash"></i> Xóa Lịch sử
                        </button>
                    </div>
                    <div class="history-grid" id="history-container">
                        <div class="empty-history">Lịch sử của bạn trống</div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIG & API ---
            const API_ENDPOINT = 'https://imagen-3.zinghay-com.workers.dev/';
            const HISTORY_KEY = 'aiImageGeneratorHistory';

            // --- DOM ELEMENTS ---
            const form = document.getElementById('generation-form');
            const generateBtn = document.getElementById('generate-btn');
            const clearBtn = document.getElementById('clear-btn');
            const statusContainer = document.getElementById('status-container');
            const imageDisplayArea = document.getElementById('image-display-area');
            const historyContainer = document.getElementById('history-container');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const promptInput = document.getElementById('prompt');
            const modelSelect = document.getElementById('model');
            const aspectRatioSelect = document.getElementById('aspect_ratio');
            const numImagesInput = document.getElementById('num_images');
            const seedInput = document.getElementById('seed');

            let history = [];

            // --- UI FUNCTIONS ---
            const showPlaceholder = () => {
                statusContainer.innerHTML = `
                    <div id="placeholder-text" class="placeholder-text">
                       <i class="fas fa-image"></i>
                       <span>Kết quả tạo ảnh sẽ xuất hiện ở đây</span>
                    </div>`;
                imageDisplayArea.innerHTML = '';
            };
            
            const showLoading = (message) => {
                statusContainer.innerHTML = `<div class="spinner"></div><p style="text-align:center;">${message}</p>`;
                imageDisplayArea.innerHTML = '';
            };

            const showError = (message) => {
                statusContainer.innerHTML = `<div class="error-message-box">${message}</div>`;
            };
            
            const clearStatus = () => {
                statusContainer.innerHTML = '';
            };

            const displayResults = (imageUrls) => {
                clearStatus();
                imageDisplayArea.innerHTML = ''; // Xóa kết quả cũ
                let successfulUploads = 0;
                
                imageUrls.forEach(url => {
                    const item = document.createElement('div');
                    item.className = 'image-grid-item';

                    let finalUrl = '';
                    if (url && (url.includes('catbox.moe') || url.startsWith('http'))) {
                       finalUrl = url;
                    } else if (url && !url.startsWith('http')) {
                       finalUrl = `https://files.catbox.moe/${url}`;
                    }

                    if (finalUrl) {
                        const img = document.createElement('img');
                        img.src = finalUrl;
                        img.alt = 'Generated AI Image';
                        img.onerror = () => {
                           item.innerHTML = `<p><strong>Lỗi tải ảnh</strong><br>URL không hợp lệ.</p>`;
                           item.classList.add('error-item');
                        };
                        item.appendChild(img);
                        successfulUploads++;
                    } else {
                        item.innerHTML = `<p><strong>Lỗi Upload</strong><br>Không thể lấy link URL từ: <em>${url || 'N/A'}</em></p>`;
                        item.classList.add('error-item');
                    }
                    imageDisplayArea.appendChild(item);
                });
                
                statusContainer.innerHTML = `<p style="text-align:center; color: var(--text-light);">Hoàn thành! Upload thành công ${successfulUploads}/${imageUrls.length} ảnh.</p>`;
            };

            // --- HISTORY FUNCTIONS ---
            const renderHistory = () => {
                historyContainer.innerHTML = '';
                if (history.length === 0) {
                    historyContainer.innerHTML = '<div class="empty-history">Lịch sử của bạn trống</div>';
                    return;
                }
                history.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    const img = document.createElement('img');
                    img.src = item.imageUrl; // Use the first image for thumbnail
                    img.alt = item.prompt;
                    historyItem.appendChild(img);
                    historyItem.addEventListener('click', () => {
                        promptInput.value = item.prompt;
                        modelSelect.value = item.model;
                        aspectRatioSelect.value = item.aspectRatio;
                        numImagesInput.value = item.numImages;
                        seedInput.value = item.seed;
                    });
                    historyContainer.appendChild(historyItem);
                });
            };

            const saveHistory = () => {
                try {
                    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                } catch (e) {
                    console.error("Lỗi khi lưu lịch sử:", e);
                }
            };
            
            const loadHistory = () => {
                try {
                    history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
                    renderHistory();
                } catch(e) {
                    console.error("Lỗi khi tải lịch sử:", e);
                    history = [];
                }
            };
            
            const addToHistory = (payload, imageUrls) => {
                const historyItem = {
                    prompt: payload.prompt,
                    model: payload.models,
                    aspectRatio: payload.aspect_ratio,
                    numImages: payload.num_images,
                    seed: payload.seed,
                    imageUrl: imageUrls[0], // Save first image for thumbnail
                    timestamp: new Date().getTime()
                };
                // Add to the beginning and keep history size limited
                history.unshift(historyItem);
                history = history.slice(0, 50); 
                saveHistory();
                renderHistory();
            };

            // --- EVENT HANDLERS ---
            const handleFormSubmit = async (event) => {
                event.preventDefault();
                const promptValue = promptInput.value.trim();
                if (!promptValue) {
                    showError('Vui lòng nhập câu lệnh (prompt).');
                    return;
                }

                generateBtn.disabled = true;
                generateBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Đang xử lý...`;
                showLoading('Bắt đầu... Worker đang gọi đến máy chủ.');

                const payload = {
                    prompt: promptValue,
                    num_images: parseInt(numImagesInput.value, 10),
                    aspect_ratio: aspectRatioSelect.value,
                    models: modelSelect.value,
                    seed: parseInt(seedInput.value, 10) || 0
                };
                
                try {
                    showLoading('Đang tạo ảnh. Worker đang chờ...');
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`API trả về lỗi ${response.status}: ${errorText}`);
                    }
                    
                    showLoading('Máy chủ đang upload ảnh...');
                    const data = await response.json();
                    
                    if (data && data.images && data.images.length > 0) {
                        displayResults(data.images);
                        addToHistory(payload, data.images);
                    } else {
                        throw new Error('API không trả về ảnh nào hoặc định dạng phản hồi không đúng.');
                    }
                } catch (error) {
                    console.error('Lỗi trong quá trình tạo ảnh:', error);
                    showError(error.message || 'Đã có lỗi không mong muốn xảy ra.');
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = `<i class="fas fa-palette"></i> Tạo ảnh ngay`;
                }
            };
            
            const handleClearForm = () => {
                promptInput.value = '';
                numImagesInput.value = 1;
                seedInput.value = '';
                showPlaceholder();
            };
            
            const handleClearHistory = () => {
                if (confirm('Bạn có chắc chắn muốn xóa toàn bộ lịch sử không?')) {
                    history = [];
                    saveHistory();
                    renderHistory();
                }
            };

            // --- INITIALIZATION ---
            form.addEventListener('submit', handleFormSubmit);
            clearBtn.addEventListener('click', handleClearForm);
            clearHistoryBtn.addEventListener('click', handleClearHistory);
            
            loadHistory();
            showPlaceholder(); // Set initial state
        });
    </script>
</body>
</html>
